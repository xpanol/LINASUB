<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Karaoke — Linia po linii</title>

<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

<style>
  :root{
    --highlight: #F6B511;
    --bg-dim: 0.55;
    --font: "Special Elite", monospace;
  }

  html,body{
    margin:0;
    padding:0;
  }

  body{
    font-family: var(--font);
    background:#000;
    color:#fff;
    padding:40px 20px;
    box-sizing:border-box;
    display:block;
  }

  @media (max-width:600px){
    body {
      padding:60px 16px;
    }
  }

  .background{
    position:fixed;
    inset:0;
    background-image:url('BACKGROUND.jpg');
    background-size:cover;
    background-position:center;
    filter:brightness(calc(1 - var(--bg-dim)));
    z-index:-1;
  }

  .app {
    width:100%;
    max-width:1000px;
    margin:0 auto;
    text-align:center;
  }

  .line-box {
    min-height:120px;
    margin:0 auto 18px;
    padding:18px;
    background:rgba(0,0,0,0.25);
    border-radius:10px;
    box-shadow:0 6px 24px rgba(0,0,0,0.5);
  }

  .line {
    font-size:24px;
    line-height:1.45;
    margin:12px 0;
    text-shadow:0 2px 6px rgba(0,0,0,0.8);
  }

  .word { transition: color 0.12s ease; }
  .word.highlight { color: var(--highlight); font-weight:700; }

  .controls {
    display:flex;
    flex-direction:row;
    gap:12px;
    justify-content:center;
    align-items:center;
    margin-top:6px;
    flex-wrap:nowrap;
  }

  .btn {
    background:var(--highlight);
    color:#000;
    border:0;
    padding:10px 16px;
    border-radius:8px;
    font-family:var(--font);
    font-size:16px;
    cursor:pointer;
    white-space:nowrap;
  }

  .btn:active { transform:translateY(1px); }

  @media (max-width:600px){
    .line { font-size:20px; }
    .line-box { padding:14px; min-height:110px; }
  }
</style>
</head>
<body>
  <div class="background" aria-hidden="true"></div>

  <div class="app" role="application" aria-label="Karaoke">
    <div class="line-box" id="lineBox" aria-live="polite"></div>

    <div class="controls" role="toolbar">
      <button class="btn" id="backBtn">Back</button>
      <button class="btn" id="playBtn">Play</button>
      <button class="btn" id="restartBtn">Restart</button>
    </div>
  </div>

  <audio id="audio" src="LINA_XPANOL.mp3" autoplay></audio>

<script>
const JSON_FILES = ['LINA_XPANOL.json'];

const audio = document.getElementById('audio');
const lineBox = document.getElementById('lineBox');
const playBtn = document.getElementById('playBtn');
const backBtn = document.getElementById('backBtn');
const restartBtn = document.getElementById('restartBtn');

let blockSize = 2;
let rawData = null;
let lines = [];
let blocks = [];
let currentBlockIndex = 0;
let rafId = null;

async function loadJsonTry(files){
  for(const f of files){
    try{
      const resp = await fetch(f);
      if(!resp.ok) continue;
      const data = await resp.json();
      return data;
    }catch(e){}
  }
  throw new Error('Nie można wczytać JSON.');
}

function normalizeData(data){
  if(!Array.isArray(data)) throw new Error('JSON musi być tablicą');
  if(data.length === 0) return [];

  if(data[0].line || data[0].words){
    return data.map(item => {
      const words = (item.words || []).map(w => ({
        text: w.text,
        start: Number(w.start),
        end: Number(w.end)
      }));
      return {
        text: item.line !== undefined ? item.line : words.map(w=>w.text).join(' '),
        start: Number(item.start || (words.length?words[0].start:0)),
        end: Number(item.end || (words.length?words[words.length-1].end:0)),
        words
      };
    });
  }

  const flat = data.map(w => ({
    text:w.text,
    start:Number(w.start),
    end:Number(w.end)
  }));

  const result = [];
  let cur = [];

  for(let i=0;i<flat.length;i++){
    const w = flat[i];
    cur.push(w);
    const lastChar = w.text.trim().slice(-1);

    if(/[.!?…]/.test(lastChar) || cur.length >= 8){
      result.push({
        text:cur.map(x=>x.text).join(' '),
        start:cur[0].start,
        end:cur[cur.length-1].end,
        words:cur.slice()
      });
      cur = [];
    }
  }
  if(cur.length){
    result.push({
      text:cur.map(x=>x.text).join(' '),
      start:cur[0].start,
      end:cur[cur.length-1].end,
      words:cur.slice()
    });
  }
  return result;
}

function buildBlocks(){
  blocks = [];
  for(let i=0;i<lines.length;i+=blockSize){
    const block = [];
    for(let j=0;j<blockSize && (i+j)<lines.length;j++){
      block.push(i+j);
    }
    blocks.push(block);
  }
}

function renderBlock(bi){
  lineBox.innerHTML = '';
  if(bi < 0 || bi >= blocks.length) return;
  const lineIndices = blocks[bi];
  lineIndices.forEach(li=>{
    const L = lines[li];
    const div = document.createElement('div');
    div.className = 'line';
    L.words.forEach((w, wi)=>{
      const span = document.createElement('span');
      span.className = 'word';
      span.id = `w_${li}_${wi}`;
      span.textContent = w.text + (wi < L.words.length-1?' ':'');
      div.appendChild(span);
    });
    lineBox.appendChild(div);
  });
}

function highlightLoop(){
  const t = audio.currentTime;
  const lineIndices = blocks[currentBlockIndex];
  let done = true;

  for(const li of lineIndices){
    const L = lines[li];
    for(let wi=0; wi<L.words.length; wi++){
      const w = L.words[wi];
      const span = document.getElementById(`w_${li}_${wi}`);
      if(!span) continue;

      if(t >= w.start && t <= w.end){
        span.classList.add('highlight');
        done = false;
      } else {
        span.classList.remove('highlight');
        if(t < w.end) done = false;
      }
    }
  }

  if(!audio.paused && done){
    const lastLine = lineIndices[lineIndices.length-1];
    const lastWord = lines[lastLine].words.at(-1);
    if(t > lastWord.end + 0.15){
      if(currentBlockIndex < blocks.length-1){
        currentBlockIndex++;
        renderBlock(currentBlockIndex);
      } else {
        audio.pause();
        playBtn.textContent = 'Play';
      }
    }
  }

  rafId = requestAnimationFrame(highlightLoop);
}

playBtn.addEventListener('click', ()=>{
  if(audio.paused){
    audio.play();
    playBtn.textContent = 'Pause';
    if(!rafId) rafId = requestAnimationFrame(highlightLoop);
  } else {
    audio.pause();
    playBtn.textContent = 'Play';
    if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  }
});

restartBtn.addEventListener('click', ()=>{
  audio.currentTime = 0;
  currentBlockIndex = 0;
  renderBlock(0);
  audio.play();
  playBtn.textContent = 'Pause';
  if(!rafId) rafId = requestAnimationFrame(highlightLoop);
});

backBtn.addEventListener('click', ()=>{
  if(currentBlockIndex > 0){
    currentBlockIndex--;
    const li = blocks[currentBlockIndex][0];
    audio.currentTime = lines[li].start;
    renderBlock(currentBlockIndex);
  } else {
    audio.currentTime = 0;
    renderBlock(0);
  }
});

audio.addEventListener('seeked', ()=>{
  const t = audio.currentTime;
  let found = false;

  for(let b=0;b<blocks.length;b++){
    for(const li of blocks[b]){
      const L = lines[li];
      if(t >= L.start && t <= L.end + 0.2){
        currentBlockIndex = b;
        found = true;
        break;
      }
    }
    if(found) break;
  }

  if(!found){
    for(let b=0;b<blocks.length;b++){
      const s = lines[blocks[b][0]].start;
      if(s > t){
        currentBlockIndex = Math.max(0,b-1);
        break;
      }
    }
  }

  renderBlock(currentBlockIndex);
});

audio.addEventListener('ended', ()=>{
  playBtn.textContent = 'Play';
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
});

(async function init(){
  try{
    rawData = await loadJsonTry(JSON_FILES);
    lines = normalizeData(rawData);
    buildBlocks();
    renderBlock(0);
    audio.play();
    rafId = requestAnimationFrame(highlightLoop);
  } catch(e){
    lineBox.innerHTML = '<div style="color:#ffb3b3">Błąd w JSON</div>';
    console.error(e);
  }
})();
</script>

</body>
</html>
